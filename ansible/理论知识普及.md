
<!-- more -->

# è‡ªåŠ¨åŒ–æ‰¹é‡ç®¡ç†-Ansible


:::tip{title="æ™®åŠæ—¶åˆ»"}
## Ansibleä»‹ç»
Ansibleæ˜¯ä¸€ä¸ªåŒæ—¶ç®¡ç†å¤šä¸ªè¿œç¨‹ä¸»æœºçš„è½¯ä»¶ï¼ˆä»»ä½•å¯ä»¥é€šè¿‡SSHåè®®ç™»å½•çš„æœºå™¨ï¼‰ï¼Œå› æ­¤Ansibleå¯ä»¥ç®¡ç†è¿œç¨‹è™šæ‹Ÿæœºã€ç‰©ç†æœºï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°ä¸»æœºã€‚

Ansibleé€šè¿‡SSHåè®®å®ç°ç®¡ç†èŠ‚ç‚¹ã€è¿œç¨‹èŠ‚ç‚¹çš„é€šä¿¡ã€‚åªè¦æ˜¯èƒ½å¤ŸSSHç™»å½•çš„ä¸»æœºå®Œæˆçš„æ“ä½œï¼Œéƒ½å¯ä»¥é€šAnsibleè‡ªåŠ¨åŒ–æ“ä½œï¼Œæ¯”å¦‚æ‰¹é‡å¤åˆ¶ã€æ‰¹é‡åˆ é™¤ã€æ‰¹é‡ä¿®æ”¹ã€æ‰¹é‡æŸ¥çœ‹ã€æ‰¹é‡å®‰è£…ã€é‡å¯ã€æ›´æ–°ç­‰ã€‚

## Ansibleç‰¹ç‚¹

Ansibleçš„ç¼–æ’å¼•æ“å¯ä»¥å‡ºè‰²çš„å®Œæˆé…ç½®ç®¡ç†ã€æµç¨‹æ§åˆ¶ã€èµ„æºéƒ¨ç½²ç­‰å¤šæ–¹é¢çš„æ“ä½œã€‚å’Œå…¶ä»–ITè‡ªåŠ¨åŒ–äº§å“æ¯”è¾ƒï¼ŒAnsibleæ— é¡»å®‰è£…å®¢æˆ·ç«¯è½¯ä»¶ï¼Œç®¡ç†ç®€ä¾¿ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œä¾¿äºç»´æŠ¤ã€‚

AnsibleåŸºäºPythonå¼€å‘ï¼Œç”±ä¸»è¦çš„Paramikoå’ŒPyYAMLä¸¤ä¸ªå…³é”®æ¨¡å—æ„å»ºã€‚

1. å®‰è£…éƒ¨ç½²ç®€å•ï¼Œå­¦ä¹ æ›²çº¿å¹³å¦
2. ç®¡ç†ä¸»æœºä¾¿æ·ï¼Œæ”¯æŒå¤šå°ä¸»æœºå¹¶è¡Œç®¡ç†
3. æ— é¡»å•ç‹¬åœ¨è¢«ç®¡ç†ä¸»æœºä¸Šå®‰è£…å®¢æˆ·ç«¯è½¯ä»¶ï¼ˆno agentsï¼‰ï¼Œæ— é¡»å ç”¨å…¶ä»–ç«¯å£ï¼Œä»…åˆ©ç”¨SSHæœåŠ¡å·¥ä½œã€‚
4. è¿œç¨‹æ‰§è¡Œå®‰å…¨ï¼Œè½»æ¾å¯¹æ‰§è¡Œçš„å†…å®¹è¿›è¡Œå®¡è®¡ã€è¯„ä¼°ã€é‡å†™
5. èƒ½å¤Ÿç«‹å³ç®¡ç†è¿œç¨‹ä¸»æœºï¼Œæ— é¡»äº‹å…ˆå®‰è£…ä»»ä½•å®¢æˆ·ç«¯ã€‚
6. ä¸ä»…æ”¯æŒpythonã€è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–è¯­è¨€å¼€å‘æ¨¡å—ã€‚
7. érootè´¦æˆ·å¯ç”¨
8. ä¸éœ€è¦å®‰è£…æœåŠ¡ç«¯(no servers)ï¼Œä¸éœ€è¦å®ˆæŠ¤è¿›ç¨‹æœåŠ¡
9. æœ‰æ´»è·ƒçš„å®˜æ–¹ç¤¾åŒº
10. åœ¨äº‘è®¡ç®—æ—¶ä»£ï¼ŒåŸºç¡€æ¶æ„å¿…é¡»æ»¡è¶³æŒ‰éœ€è‡ªåŠ¨ä¼¸ç¼©ã€æŒ‰ä½¿ç”¨é‡è®¡è´¹çš„åŸºæœ¬ç‰¹æ€§ï¼Œå› æ­¤è‡ªåŠ¨åŒ–è¿ç»´è½¯ä»¶æ˜¯å¿…å¤‡çš„å·¥å…·ä¹‹ä¸€ã€‚

## Ansibleå·¥ä½œåŸç†
å¤§è‡´å·¥ä½œåŸç†å°±æ˜¯ansibleç¨‹åºè°ƒç”¨è¯»å–/etc/ansible/ansible.cfgé…ç½®æ–‡ä»¶è·å–ä¸»æœºåˆ—è¡¨æ¸…å•/etc/ansible/hostsæ–‡ä»¶ï¼Œè·å–æ‰€è¦å¤„ç†çš„ä¸»æœºåˆ—è¡¨ï¼Œç„¶åæŸ¥çœ‹å‰§æœ¬ä»»åŠ¡ï¼Œåœ¨æ ¹æ®å‰§æœ¬ä¸­ä¸€ç³»åˆ—ä»»åŠ¡ç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„è„šæœ¬æ–‡ä»¶ï¼Œç„¶åå°†è¯¥è„šæœ¬æ–‡ä»¶å‘é€ç»™æ‰€ç®¡ç†çš„ä¸»æœºï¼Œè„šæœ¬æ–‡ä»¶åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œå®Œæˆåè¿”å›ç»“æœï¼Œç„¶ååˆ é™¤æœ¬åœ°ä¸´æ—¶æ–‡ä»¶

## ansibleå·¥ä½œæ¨¡å¼
ansibleåˆ†ä¸ºä¸¤ç§å·¥ä½œæ¨¡å¼ï¼š

ä¸€æ˜¯adhocï¼ˆç‚¹å¯¹ç‚¹æ¨¡å¼ï¼‰ï¼šæ­¤æ¨¡å¼ç›¸å½“äºå¯¹ç®¡ç†ä¸»æœºæ‰§è¡Œå•ä¸ªçš„shellå‘½ä»¤

äºŒæ˜¯playbookï¼ˆå‰§æœ¬æ¨¡å¼ï¼‰ï¼šè¯¥æ¨¡å¼åº”ç”¨è¾ƒå¤šï¼Œè¯¥æ¨¡å¼æ˜¯æŒ‡å°†ä¸€ç³»åˆ—ä»»åŠ¡æ•´åˆå½¢æˆä¸€ä¸ªå‰§æœ¬ï¼Œä»¥æ­¤æ¥è¾¾æˆæŸç§åŠŸèƒ½ï¼ˆè­¬å¦‚éƒ¨ç½²æŸä¸ªæœåŠ¡ï¼Œæ•°æ®åº“å¤‡ä»½ç­‰ï¼‰çš„ç›®çš„ã€‚

ä¸Šè¿°ä¸¤ç§æ¨¡å¼å¯ç±»æ¯”äºä¸€ä¸ªæ˜¯æ‰§è¡Œå•ä¸ªshellå‘½ä»¤ï¼Œä¸€ä¸ªæ˜¯shellè„šæœ¬
:::

:::info{title="å°ç»“"}
æ‰¹é‡ç®¡ç†å¤šå°æœºå™¨ï¼Œå®ç°è‡ªåŠ¨åŒ–è¿ç»´ï¼Œæ­é…sshå…å¯†ä½¿ç”¨
:::

![20241129232834](https://liu-fu-gui.github.io/myimg/halo/20241129232834.png)

![20241129232842](https://liu-fu-gui.github.io/myimg/halo/20241129232842.png)


# å‘½ä»¤å‚æ•°ä»‹ç»

:::tip{title="å‚æ•°"}
ansibleçš„ä¸ƒä¸ªå‘½ä»¤
å®‰è£…å®Œansibleåï¼Œå‘ç°ansibleä¸€å…±ä¸ºæˆ‘ä»¬æä¾›äº†ä¸ƒä¸ªæŒ‡ä»¤ï¼šansibleã€ansible-docã€ansible-galaxyã€ansible-lintã€ansible-playbookã€ansible-pullã€ansible-vault ã€‚è¿™é‡Œæˆ‘ä»¬åªæŸ¥çœ‹usageéƒ¨åˆ†ï¼Œè¯¦ç»†éƒ¨åˆ†å¯ä»¥é€šè¿‡ "æŒ‡ä»¤ -h" çš„æ–¹å¼è·å–ã€‚

## 1ã€ansible

ansibleæ˜¯æŒ‡ä»¤æ ¸å¿ƒéƒ¨åˆ†ï¼Œå…¶ä¸»è¦ç”¨äºæ‰§è¡Œad-hocå‘½ä»¤ï¼Œå³å•æ¡å‘½ä»¤ã€‚é»˜è®¤åé¢éœ€è¦è·Ÿä¸»æœºå’Œé€‰é¡¹éƒ¨åˆ†ï¼Œé»˜è®¤ä¸æŒ‡å®šæ¨¡å—æ—¶ï¼Œä½¿ç”¨çš„æ˜¯commandæ¨¡å—ã€‚å¦‚ï¼šansible 192.168.0.102 -a 'date'ï¼Œä¸è¿‡é»˜è®¤ä½¿ç”¨çš„æ¨¡å—æ˜¯å¯ä»¥åœ¨ansible.cfg ä¸­è¿›è¡Œä¿®æ”¹çš„ã€‚

## 2ã€ansible-doc

è¯¥æŒ‡ä»¤ç”¨äºæŸ¥çœ‹æ¨¡å—ä¿¡æ¯ï¼Œå¸¸ç”¨å‚æ•°æœ‰ä¸¤ä¸ª-l å’Œ -s

#åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„æ¨¡å—
ansible-doc  -l
#æŸ¥çœ‹å…·ä½“æŸæ¨¡å—çš„ç”¨æ³•ï¼Œè¿™é‡Œå¦‚æŸ¥çœ‹commandæ¨¡å—
ansible-doc  -s command
## 3ã€ansible-galaxy

ansible-galaxy æŒ‡ä»¤ç”¨äºæ–¹ä¾¿çš„ä»https://galaxy.ansible.com/ ç«™ç‚¹ä¸‹è½½ç¬¬ä¸‰æ–¹æ‰©å±•æ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥å½¢è±¡çš„ç†è§£å…¶ç±»ä¼¼äºcentosä¸‹çš„yumã€pythonä¸‹çš„pipæˆ–easy_install ã€‚å¦‚ä¸‹ç¤ºä¾‹ï¼šansible-galaxy install aeriscloud.docker

è¿™ä¸ªå®‰è£…äº†ä¸€ä¸ªaeriscloud.dockerç»„ä»¶ï¼Œå‰é¢aeriscloudæ˜¯galaxyä¸Šåˆ›å»ºè¯¥æ¨¡å—çš„ç”¨æˆ·åï¼Œåé¢å¯¹åº”çš„æ˜¯å…¶æ¨¡å—ã€‚åœ¨å®é™…åº”ç”¨ä¸­ä¹Ÿå¯ä»¥æŒ‡å®štxtæˆ–yml æ–‡ä»¶è¿›è¡Œå¤šä¸ªç»„ä»¶çš„ä¸‹è½½å®‰è£…ã€‚è¿™éƒ¨åˆ†å¯ä»¥å‚çœ‹å®˜æ–¹æ–‡æ¡£(opens new window)

## 4ã€ansible-lint

ansible-lintæ˜¯å¯¹playbookçš„è¯­æ³•è¿›è¡Œæ£€æŸ¥çš„ä¸€ä¸ªå·¥å…·ã€‚ç”¨æ³•æ˜¯ansible-lint playbook.yml ã€‚

## 5ã€ansible-playbook

è¯¥æŒ‡ä»¤æ˜¯ä½¿ç”¨æœ€å¤šçš„æŒ‡ä»¤ï¼Œå…¶é€šè¿‡è¯»å–playbook æ–‡ä»¶åï¼Œæ‰§è¡Œç›¸åº”çš„åŠ¨ä½œï¼Œè¿™ä¸ªåé¢ä¼šåšä¸ºä¸€ä¸ªé‡ç‚¹æ¥è®²ã€‚

## 6ã€ansible-pull

è¯¥æŒ‡ä»¤ä½¿ç”¨éœ€è¦è°ˆåˆ°ansibleçš„å¦ä¸€ç§æ¨¡å¼ï¼ï¼ï¼pull æ¨¡å¼ï¼Œè¿™å’Œæˆ‘ä»¬å¹³å¸¸ç»å¸¸ç”¨çš„pushæ¨¡å¼åˆšå¥½ç›¸åï¼Œå…¶é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼šä½ æœ‰æ•°é‡å·¨å¤§çš„æœºå™¨éœ€è¦é…ç½®ï¼Œå³ä½¿ä½¿ç”¨éå¸¸é«˜çš„çº¿ç¨‹è¿˜æ˜¯è¦èŠ±è´¹å¾ˆå¤šæ—¶é—´ï¼›ä½ è¦åœ¨ä¸€ä¸ªæ²¡æœ‰ç½‘ç»œè¿æ¥çš„æœºå™¨ä¸Šè¿è¡ŒAnisbleï¼Œæ¯”å¦‚åœ¨å¯åŠ¨ä¹‹åå®‰è£…ã€‚è¿™éƒ¨åˆ†ä¹Ÿä¼šå•ç‹¬åšä¸€èŠ‚æ¥è®²ã€‚

## 7ã€ansible-vault

ansible-vaultä¸»è¦åº”ç”¨äºé…ç½®æ–‡ä»¶ä¸­å«æœ‰æ•æ„Ÿä¿¡æ¯ï¼Œåˆä¸å¸Œæœ›ä»–èƒ½è¢«äººçœ‹åˆ°ï¼Œvaultå¯ä»¥å¸®ä½ åŠ å¯†/è§£å¯†è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå±é«˜çº§ç”¨æ³•ã€‚ä¸»è¦å¯¹äºplaybooksé‡Œæ¯”å¦‚æ¶‰åŠåˆ°é…ç½®å¯†ç æˆ–å…¶ä»–å˜é‡æ—¶ï¼Œå¯ä»¥é€šè¿‡è¯¥æŒ‡ä»¤åŠ å¯†ï¼Œè¿™æ ·æˆ‘ä»¬é€šè¿‡catçœ‹åˆ°çš„ä¼šæ˜¯ä¸€ä¸ªå¯†ç ä¸²ç±»çš„æ–‡ä»¶ï¼Œç¼–è¾‘çš„æ—¶å€™éœ€è¦è¾“å…¥äº‹å…ˆè®¾å®šçš„å¯†ç æ‰èƒ½æ‰“å¼€ã€‚è¿™ç§playbookæ–‡ä»¶åœ¨æ‰§è¡Œæ—¶ï¼Œéœ€è¦åŠ ä¸Š --ask-vault-passå‚æ•°ï¼ŒåŒæ ·éœ€è¦è¾“å…¥å¯†ç åæ‰èƒ½æ­£å¸¸æ‰§è¡Œã€‚å…·ä½“è¯¥éƒ¨åˆ†å¯ä»¥å‚æŸ¥å®˜æ–¹åšå®¢ (opens new window)ã€‚
:::

## ç¯å¢ƒå‡†å¤‡

| ansibleç¯å¢ƒ | ä¸»æœºåå’Œip |
| --- | --- |
| ansibleç®¡ç†ç«¯ | m01 10.0.0.61 |
| è¢«ç®¡ç†æœºå™¨ | web01 10.0.0.7 |

	
## ansibleéƒ¨ç½²
### ä¸»m01ä¸Šå®‰è£…

```
yum install -y ansible
```
å®‰è£…å®Œä¹‹åæŠŠä½ è¦ç®¡ç†çš„æœºå™¨ipä¸€è¡Œä¸€è¡Œæ”¾è¿™é‡Œé¢
è¿™ä¸ªoldboyæ˜¯ä¸€ä¸ªç»„ï¼Œç›¸å½“äºä½ ç›´æ¥è°ƒç”¨ç»„é‡Œé¢çš„æœºå™¨ipå°±å¯ä»¥ï¼Œæ˜¯ä¸æ˜¯å¾ˆæ–¹ä¾¿

```
[root@m01 ~]$ cat /etc/ansible/hosts
[oldboy]
172.16.1.7
172.16.1.31
172.16.1.41
172.16.1.51
```
å¼„å¥½å°±æµ‹è¯•ä¸€ä¸‹å§

```
#å¯¹oldboyç»„æ‰§è¡Œ pingå‘½ä»¤
[root@m01 ~]$ ansible oldboy -m ping   

ç¨å¾®è§£é‡Šä¸‹å§
olbdoyæ˜¯æˆ‘ä»¬ä¸Šé¢è®¾ç½®çš„cat /etc/ansible/hostsåå•é‡Œé¢çš„ç»„ï¼Œæ„æ€å°±æ˜¯æˆ‘ç”¨ansibleæ§åˆ¶è¿™ä¸ªç»„é‡Œçš„æœºå™¨ï¼ŒåŒæ—¶å»æ‰§è¡Œpingå‘½ä»¤
-m  å‘½ä»¤ï¼šè¿™æ˜¯æŒ‡å®šæ¨¡å—
```

å¸¸ç”¨å‘½ä»¤

```
ansible db  -m command -a 'hostname' # æŸ¥çœ‹dbç»„
ansible all  -m command -a 'hostname' # æŸ¥çœ‹å…¨éƒ¨
ansible 172.16.1.7  -m command -a 'hostname' # æŸ¥çœ‹å•æœº
```
:::tip{title="çœ‹ä¸æ‡‚å‘½ä»¤å°±å»ç ”ç©¶ä¸‹"}
é€šè¿‡å‘½ä»¤: ansible-doc -s command
å®˜ç½‘åœ°å€
https://docs.ansible.com/ansible/latest/collections/ansible/builtin/index.html#plugins-in-ansible-builtin

:::

å¥½äº†ä¸Šé¢è®²å®Œä¸‹é¢å°±è¦æ·±å…¥è®²ä¸‹äº†ï¼Œè§‰å¾—å¤Ÿç”¨çš„å¯ä»¥èµ°äº†

## æ¨¡å—


### 1. Ans-å‘½ä»¤ä¸è„šæœ¬ç±»æ¨¡![20241129232857](https://liu-fu-gui.github.io/myimg/halo/20241129232857.png)å—

#### 1.1 commandæ¨¡å—
:::tip{title=""}
ä»…æ”¯æŒç®€å•å‘½ä»¤,ä¸æ”¯æŒç‰¹æ®Šç¬¦å·,ç®¡é“....

âš  è¿™ä¸ªæ¨¡å—æ˜¯é»˜è®¤æ¨¡å—,ansibleä¸åŠ ä¸Šæ¨¡å—,é»˜è®¤å°±ä½¿ç”¨è¿™ä¸ªæ¨¡å—.
:::


```
ansible all     -m command -a 'å‘½ä»¤'
ansible all     -a 'hostname' #ç›¸å½“äºçœç•¥ -m command

ansible allå°±æ˜¯ï¼Œæˆ‘ä¸æŒ‡å®šç»„äº†ï¼Œæˆ‘æ¸…å•é‡Œé¢çš„æœºå™¨éƒ½å»æ‰§è¡Œæˆ‘çš„æ“ä½œ

```
#### 1.2 shellæ¨¡å—
ä¸commandæ¨¡å—ç±»ä¼¼,shellæ¨¡å—æ”¯æŒç‰¹æ®Šç¬¦å·,æ‰§è¡Œè„šæœ¬....

```
ansible all -m command -a 'ip a s eth0 |sed -n 3p'
ansible all -m shell -a 'ip a s eth0 |sed -n 3p'
```
![20241129232911](https://liu-fu-gui.github.io/myimg/halo/20241129232911.png)

ansibleä¸­çš„é¢œè‰²ä»£è¡¨ä»€ä¹ˆ

:::warning{title="ansibleä¸­çš„é¢œè‰²ä»£è¡¨ä»€ä¹ˆ"}
**ç»¿è‰²** è¡¨ç¤ºæ­£å¸¸ \
**é»„è‰²** è¡¨ç¤ºæ‰§è¡Œæ­£å¸¸,çŠ¶æ€å˜åŒ–\
**çº¢è‰²** è¡¨ç¤ºé”™è¯¯,è¾“å‡ºé”™è¯¯ä¿¡æ¯\
**ç´«è‰²** è¡¨ç¤ºè­¦å‘Š,å»ºè®®
:::

#### 1.3  scriptæ¨¡å—-ä¼ è¾“è„šæœ¬åˆ°è¢«ç®¡ç†ç«¯å¹¶æ‰§è¡Œè„šæœ¬
:::info{title="ä½œç”¨"}
ä¼ è¾“è„šæœ¬\
æ‰§è¡Œè„šæœ¬\
å¡ä½éœ€è¦æ¸…ç†ä¸‹ : è¢«ç®¡ç†æœºå™¨çš„yumç¼“å­˜.
:::


```
å®‰è£…ipvsadm 
[root@m01 ~]$ cat /server/scripts/yum.sh 
[root@m01 ~]$ yum install -y ipvsadm
ä½¿ç”¨script æ¨¡å—æ‰§è¡Œè„šæœ¬.
[root@m01 ~]$ ansible db -m script  -a '/server/scripts/yum.sh'
```
#### 1.4 å°ç»“

:::tip{title="å°ç»“"}
**commandæ¨¡å—** \
**ä½œç”¨** æ‰§è¡Œå‘½ä»¤\
**åº”ç”¨**
ç®€å•å‘½ä»¤,ä¸å«ç‰¹æ®Šç¬¦å·. é»˜è®¤çš„æ¨¡å—
ansible all -a 'hostname'

**shellæ¨¡å—** \
**ä½œç”¨** æ‰§è¡Œå‘½ä»¤æˆ–è„šæœ¬\
**åº”ç”¨**
æ‰§è¡Œå«æœ‰ç‰¹æ®Šç¬¦å·: ç®¡é“,åå¼•å·,{}çš„å‘½ä»¤,è¿è¡Œè„šæœ¬. (è„šæœ¬åœ¨è¢«ç®¡ç†ç«¯)

**scriptæ¨¡å—** \
**ä½œç”¨**
å…ˆä¼ è¾“è„šæœ¬,ç„¶åè¿è¡Œè„šæœ¬\
**åº”ç”¨**
ä¸€èˆ¬ç”¨äºæ‰§è¡Œè„šæœ¬
:::

## Ans-æ–‡ä»¶ä¸ç›®å½•ç®¡ç†æ¨¡å—

:::tip{title="æç¤º"}
file åˆ›å»ºæ–‡ä»¶,ç›®å½•\
copy è¿œç¨‹ä¼ è¾“æ–‡ä»¶,ç›®å½•.ç±»ä¼¼äºscp
:::
### fileæ¨¡å—
ç®¡ç†æ–‡ä»¶æˆ–ç›®å½•,è½¯è¿æ¥

![20241129232939](https://liu-fu-gui.github.io/myimg/halo/20241129232939.png)

| fileæ¨¡å—ä¸­çš„é€‰é¡¹ |  |
| --- | --- |
| path | è·¯å¾„(ç›®å½•,æ–‡ä»¶) å¿…é¡»è¦å†™ |
| src (sourceæº) | æºæ–‡ä»¶ä¸€èˆ¬ç”¨äºlink(åˆ›å»ºè½¯è¿æ¥æ¨¡å¼) ç”¨äºæŒ‡å®šæºæ–‡ä»¶ |
| state | çŠ¶æ€(æ¨¡å¼)  state=directory åˆ›å»ºç›® state=file (é»˜è®¤) æ›´æ–°æ–‡ä»¶,å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ä¹Ÿä¸åˆ›å»º. state=link åˆ›å»ºè½¯è¿æ¥ state=touch åˆ›å»ºæ–‡ä»¶ state=absent åˆ é™¤ |

#### å°æµ‹è¯•
æ¡ˆä¾‹01-åˆ›å»ºç›®å½•/oldboy/ç›®å½• â­â­â­â­â­

```
 ansible all -m file  -a 'path=/oldboy state=directory'
 ansible all -a 'ls -ld /oldboy/'
 
 æˆ‘ä»¬åº”è¯¥æ€ä¹ˆå»ç†è§£è¿™ä¸ªï¼Ÿ
 fileæ¨¡å—ï¼Œå°±æ˜¯å’Œæ–‡ä»¶æ“ä½œç›¸å…³çš„ï¼Œæˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„æ—¶å€™ï¼Œå…³äºæ–‡ä»¶çš„æ— éæ˜¯ã€å¤åˆ¶ã€ç²˜è´´ã€ç§»åŠ¨ã€åˆ é™¤ã€åˆ›å»ºã€æˆæƒï¼›å…¶å®ansileè¿™ä¸ªæ¨¡å—å°±æ˜¯ä¸“é—¨å¸®æˆ‘ä»¬å¤„ç†æ–‡ä»¶ç›¸å…³çš„ã€‚  ä½ è¦è€ƒè™‘çš„æ˜¯ï¼Œæˆ‘ä½¿ç”¨è¿™ä¸ªæ¨¡å—ï¼Œç§»åŠ¨çš„è¯ï¼Œåº”è¯¥æ€ä¹ˆå¼„ï¼Ÿ 
 --- state   :åŠ¨ä½œï¼Œæˆ‘ä»¬æ˜¯è¦å¯¹æ–‡ä»¶åšä»€ä¹ˆæ“ä½œï¼Ÿ
 --- src     : æºï¼Œå°±æ˜¯ä½ çš„ç›®æ ‡ï¼Œä½ å½“å‰æ‰§è¡Œæ“ä½œè¿™å°ç”µè„‘é‡Œé¢çš„å†…å®¹ã€‚
 --- path    : ä½ è¦æŠŠä½ çš„ç›®æ ‡æ–‡ä»¶æ”¾åˆ°å“ªé‡Œ

```
æ¡ˆä¾‹02-åˆ›å»ºæ–‡ä»¶/oldboy/oldboy.txtæ–‡ä»¶â­â­â­â­â­

```
ansible all -m file -a 'path=/oldboy/oldboy.txt state=touch'
#ç»™ansibleæ¸…å•é‡Œé¢çš„æ‰€æœ‰æœºå™¨ï¼Œtouch----ã€‹åˆ›å»ºã€‚ æ–‡ä»¶åˆ›å»ºçš„è·¯å¾„path=/oldboy/oldboy.txt 
#æˆ‘ä»¬åˆ›å»ºå®Œæˆä¹‹åï¼Œè¦å»æ£€æŸ¥ï¼Œæ‰¾å‡ ä¸ªä¸»æœºçœ‹çœ‹ï¼Œæ˜¯ä¸æ˜¯æœ‰è¿™ä¸ªæ–‡ä»¶
ansible all -a 'ls -l /oldboy/'
```

æ¡ˆä¾‹03-åˆ›å»ºè½¯è¿æ¥ /oldboy/oldboy.txtåˆ°/tmp/oldboy.txt.soft â­


```
ansible all -m file -a 'src=/oldboy/oldboy.txt path=/tmp/oldboy.txt.soft state=link'
ansible all -a 'ls -l /tmp/oldboy.txt.soft'
```

æ¡ˆä¾‹04-åˆ é™¤æ–‡ä»¶/ç›®å½•/è½¯è¿æ¥â­â­â­â­â­

```
ansible all  -m file -a 'path=/oldboy/oldboy.txt state=absent '     #åˆ é™¤æ–‡ä»¶
ansible all  -m file -a 'path=/oldboy state=absent '      #åˆ é™¤ç›®å½•
ansible all  -m file -a 'path=/tmp/oldboy.txt.soft state=absent ' #åˆ é™¤è½¯è¿
```
æ¡ˆä¾‹05-åˆ›å»ºæ–‡ä»¶/tmp/oldboy.txt,æ‰€æœ‰è€…root,ç”¨æˆ·ç»„root,æƒé™755

```
ansible all -m file -a 'path=/tmp/oldboy.txt owner=root group=root mode=755   state=touch'
ansible all -a 'ls -l /tmp/oldboy.txt'
```
### copy è¿œç¨‹ä¼ è¾“æ¨¡å—

| copyæ¨¡å— |  |
| --- | --- |
| src | source æºæ–‡ä»¶ |
| dest | destination ç›®æ ‡ |
| backup | backup=yes åˆ™ä¼šåœ¨è¦†ç›–å‰è¿›è¡Œå¤‡ä»½ |
| mode | ä¿®æ”¹æƒé™ |
| owner | ä¿®æ”¹ä¸ºæŒ‡å®šæ‰€æœ‰è€… |
| group | ä¿®æ”¹ä¸ºæŒ‡å®šç”¨æˆ·ç»„ |
æ¡ˆä¾‹01-ä¼ è¾“/etc/hostsæ–‡ä»¶åˆ°/etc/hosts â­â­â­â­â­

```
ansible all -m copy -a 'src=/etc/hosts  dest=/etc/hosts'
#å¤åˆ¶æ¨¡å—ï¼Œå’Œæˆ‘ä»¬fileæ¨¡å—å·®ä¸å¤š
---src :ä½ å¤åˆ¶çš„æºç›®æ ‡ï¼Œå°±æ˜¯ä½ è¦å¤åˆ¶çš„æ–‡ä»¶
---dest:  ä½ è¦å¤åˆ¶åˆ°ç›®æ ‡æœºå™¨å“ªä¸ªä½ç½®
```

æ¡ˆä¾‹02-ä¼ è¾“/etc/hostsæ–‡ä»¶åˆ°/etc/hosts-å…ˆå¤‡ä»½ç„¶åä¿®æ”¹â­â­â­â­

```
ansible all -m copy -a 'src=/etc/hosts  dest=/etc/hosts backup=yes'
ansible all -m shell -a 'ls -l /etc/hosts*' 
```
###  æ–‡ä»¶ç®¡ç†ä¸ä¼ è¾“æ¨¡å—å°ç»“

| æ–‡ä»¶ç®¡ç†ä¸ä¼ è¾“æ¨¡å— | å«ä¹‰ |
| --- | --- |
| file | åˆ›å»º/åˆ é™¤ æ–‡ä»¶/ç›®å½•,è½¯è¿æ¥ |
| copy | è¿œç¨‹åˆ†å‘æ–‡ä»¶/ç›®å½•,è½¯ä»¶åŒ…,å‹ç¼©åŒ… |

## Ans-æœåŠ¡ç®¡ç†æ¨¡å—

:::tip{title="systemctl å‘½ä»¤"}
å¯åŠ¨/å…³é—­/é‡å¯æœåŠ¡ å¼€æœºè‡ªå¯åŠ¨/å¼€æœºä¸è‡ªå¯åŠ¨
:::

### systemdâ­â­â­â­â­

| systemdæ¨¡å— |  |
| --- | --- |
| name | ç”¨äºæŒ‡å®šæœåŠ¡åç§° |
| enabled | æ§åˆ¶æœåŠ¡çš„å¼€æœºè‡ªå¯åŠ¨ enabled=yes /enabled=no |
| state | è¡¨ç¤ºæœåŠ¡å¼€,å…³,é‡å¯... state=started å¼€å¯ state=stopped å…³é—­ state=reloaded é‡è¯»é…ç½®æ–‡ä»¶(æœåŠ¡æ”¯æŒ) sshd,nfs state=restarted é‡å¯(å…³é—­å†å¼€å¯) |
| daemon-reload | yesæ˜¯å¦é‡æ–°åŠ è½½å¯¹åº”çš„æœåŠ¡çš„ç®¡ç†é…ç½®æ–‡ä»¶(è®²è§£äº†systemctlé…ç½®æ–‡ä»¶.) |

#### æ¡ˆä¾‹01-å…³é—­firewalld

:::tip{title="å®ç°åŠŸèƒ½"}
æ­£åœ¨è¿è¡Œ
å…³é—­å¼€æœºè‡ªå¯åŠ¨.
:::

```
æˆ‘ä»¬linuxå…³é—­é˜²ç«å¢™çš„å‘½ä»¤ï¼šsystemctl stop firewalld
ansible all -m systemd -a 'name=firewalld enabled=no state=stopped'
#è¿™ä¸ªsystemdæ¨¡å—å°±æ˜¯é’ˆå¯¹ä½¿ç”¨systemctlå‘½ä»¤å¼€å¯ã€å…³é—­ã€é‡å¯ç­‰æ“ä½œçš„
name:å°±æ˜¯ä½ æœåŠ¡çš„åç§°ï¼Œä½ å¯ä»¥å…ˆæ‰¾æ‰“è¿™ä¸ªæœåŠ¡çš„åç§°
enable:è®¾ç½®æ˜¯å¦å¼€æœºè‡ªå¯
state:è®¾ç½®æœåŠ¡çš„å¼€ã€å…³é‡å¯

ansible all -a 'systemctl status firewalld'
#æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ç”¨é‚£ä¹ˆéº»çƒ¦ï¼Œç›´æ¥ä½¿ç”¨commandæ¨¡å—ï¼Œæ‰§è¡Œæ•´ä¸ªå‘½ä»¤
```

#### æ¡ˆä¾‹02-å¼€å¯sshdæœåŠ¡

```
ansible all -m systemd -a 'name=sshd enabled=yes state=started'
ansible all -a 'systemctl status sshd'
```

#### æ¡ˆä¾‹03-é‡å¯backupè¿™å°æœºå™¨ä¸Šé¢çš„rsyncæœåŠ¡

```
ansible backup -m systemd -a 'name=rsyncd state=restarted'
```
## service äº†è§£

![20241129233056](https://liu-fu-gui.github.io/myimg/halo/20241129233056.png)

## Ans-è½¯ä»¶åŒ…ç®¡ç†æ¨¡å—

:::tip{title="æç¤º"}
yum_repository (ç®¡ç†yumæº)\
yum (yumå‘½ä»¤)\
get_url(wgetå‘½ä»¤)
:::

### yumæºé…ç½®ç®¡ç†æ¨¡å—

![20241129233104](https://liu-fu-gui.github.io/myimg/halo/20241129233104.png)

![20241129233110](https://liu-fu-gui.github.io/myimg/halo/20241129233110.png)


```
[root@m01 ~]$ cat /etc/yum.repos.d/epel.repo 
[epel]
name=Extra Packages for Enterprise Linux 7 -$basearch
baseurl=http://mirrors.aliyun.com/epel/7/$basearch
failovermethod=priority
enabled=1
gpgcheck=0
gpgkey=file://etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
```

#### æ¡ˆä¾‹01-æ‰¹é‡æ·»åŠ nginx-yumæº

```
[root@m01 ~]$ cat /etc/yum.repos.d/nginx.repo 
[nginx]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key



ansible web -m yum_repository  -a 'name=nginx description="nginx stable repo" baseurl="http://nginx.org/packages/centos/$releasever/$basearch/" gpgcheck=no       enabled=yes'
#æ³¨æ„æœªæ¥ä¹Ÿå¯ä»¥é€šè¿‡,copyæ¨¡å—å®ç°.
```

### yumæ¨¡å— â­â­â­â­â­


#### æ¡ˆä¾‹01-å®‰è£…lrzsz

```
ansible all     -a 'rpm -e lrzsz '
ansible all     -m yum -a 'name=lrzsz state=installed '
```
#### æ¡ˆä¾‹02-å®‰è£…sl,cowsay,aalib

```
ansible web  -m yum -a 'name=sl,cowsay,aalib state=installed'
```

###  get_urlæ¨¡å—(wget) â­â­â­â­â­

| get_urlä¸‹è½½åŠŸèƒ½ |  |
| --- | --- |
| url	 | æŒ‡å®šè¦ä¸‹è½½çš„åœ°å€ |
| dest | ä¸‹è½½åˆ°å“ªä¸ªç›®å½• |

#### æ¡ˆä¾‹01-ä¸‹è½½tengineæºç åŒ…åˆ°/server/tools/(ä¸å­˜åœ¨)ç›®å½•ä¸‹

```
ä¸‹è½½åœ°å€: https://tengine.taobao.org/download/tengine-2.3.3.tar.gz

ansible web -m file -a 'path=/server/tools/ state=directory'
ansible web -m get_url -a'url=https://tengine.taobao.org/download/tengine-2.3.3.tar.gz  dest=/server/tools/'
ansible web -a 'tree /server/'
```

## è½¯ä»¶åŒ…ç®¡ç†æ¨¡å—å°ç»“

| æ¨¡å—åå­— |  |
| --- | --- |
| yum_repository | yumæºé…ç½®æ–‡ä»¶ |
| yum | é€šè¿‡yumå‘½ä»¤å®‰è£…è½¯ä»¶ |
| get_url | wgetå‘½ä»¤ä¸‹è½½è½¯ä»¶åŒ…/æºç ,ä¸‹è½½æ–‡ä»¶ |

##  ç³»ç»Ÿç®¡ç†æ¨¡å—
### mountæ¨¡å— â­â­â­â­â­


![20241129233207](https://liu-fu-gui.github.io/myimg/halo/20241129233207.png)


#### æ¡ˆä¾‹01-æŒ‚è½½æ¡ˆä¾‹

```
web01æŠŠ nfså…±äº«çš„ç›®å½•/dataç›®å½•æŒ‚è½½åˆ° web01çš„/upload_video 

æ­¥éª¤01_web01ä¸Šé¢åˆ›å»ºæŒ‚è½½ç‚¹/upload_video
ansible web -m file -a 'path=/upload_video  state=directory'

æ­¥éª¤02_æŒ‚è½½nfs
 ansible web -m mount  -a 'fstype=nfs src="172.16.1.31:/data" path=/upload_videostate=mounted '
 ansible web -a 'df -h'
 ansible web -a 'tail -2 /etc/fstab'
```

### cronå®šæ—¶ä»»åŠ¡æ¨¡å—

![20241129233216](https://liu-fu-gui.github.io/myimg/halo/20241129233216.png)

#### æ¡ˆä¾‹01-æ·»åŠ è‡ªåŠ¨åŒæ­¥æ—¶é—´çš„å®šæ—¶ä»»åŠ¡

```
#1. sync time lidao996 
*/2 * * * * /sbin/ntpdate ntp1.aliyun.com &>/dev/null
æ­¥éª¤01_å¤‡ä»½æ•°æ®
ansible all -a 'cp /var/spool/cron/root /tmp/'
ansible all -a 'ls -l /tmp/root'
ansible all -a 'crontab -r'

æ­¥éª¤02_ä¹¦å†™å®šæ—¶ä»»åŠ¡
ansible all -m cron -a 'name="sync time by lidao996 20221111" minute="*/2" job="/sbin/ntpdate ntp1.aliyun.com &>/dev/null" state=present'
```

## ç”¨æˆ·ç®¡ç†æ¨¡å—

:::tip{title="æç¤º"}
groupåˆ›å»ºç»„æ¨¡å—\
useråˆ›å»ºç”¨æˆ·æ¨¡å—â­ â­ â­ â­ â­
:::
###  userâ­â­â­â­

![20241129233224](https://liu-fu-gui.github.io/myimg/halo/20241129233224.png)

#### æ¡ˆä¾‹01-åˆ›å»ºç”¨æˆ·lidao996

```
[root@m01 ~]# ansible web -m user -a 'name=lidao996'
```
#### æ¡ˆä¾‹02-åˆ›å»ºè™šæ‹Ÿç”¨æˆ·tengine,æŒ‡å®šuidä¸º10086
- å‘½ä»¤è§£é‡Šå™¨: /sbin/nologin
- ä¸åˆ›å»ºå®¶ç›®å½•

```
useradd -u 10086  -s /sbin/nologin -M  tengine

[root@m01 ~]# ansible web -m user -a 'name=tengine uid=10086 shell=/sbin/nologin create_home=no state=present'
172.16.1.7 | CHANGED ==> {
 "ansible_facts": {
    "discovered_interpreter_python": 
"/usr/bin/python"
  }, 
 "changed": true, 
 "comment": "", 
 "create_home": false, 
  "group": 10086, 
  "home": "/home/tengine", 
 "name": "tengine", 
  "shell": "/sbin/nologin", 
  "state": "present", 
  "system": false, 
 "uid": 10086
 }
[root@m01 ~]# ansible web -a 'id tengine'
172.16.1.7 | CHANGED | rc=0 >>
uid=10086(tengine) gid=10086(tengine) 
groups=10086(tengine)
[root@m01 ]# ansible web -a 'grep tengine /etc/passwd'
172.16.1.7 | CHANGED | rc=0 >>
tengine:x:10086:10086::/home/tengine:/sbin/nologin
```

### groupæ¨¡å—

![20241129233235](https://liu-fu-gui.github.io/myimg/halo/20241129233235.png)


##  Ansæ¨¡å—å®æˆ˜-éƒ¨ç½²rsyncæœåŠ¡ç«¯

:::tip{title=" åˆ—å‡ºæµç¨‹"}
éƒ¨ç½²rsyncæœåŠ¡ç«¯éœ€è¦ä»€ä¹ˆæ¨¡å—ä¸æµç¨‹

1ï¸âƒ£ yum å®‰è£…æˆ–æ›´æ–° 
2ï¸âƒ£ é…ç½®æ–‡ä»¶ 3ï¸âƒ£ è™šæ‹Ÿç”¨æˆ· rsync 4ï¸âƒ£ å¯†ç æ–‡ä»¶å’Œæƒé™ 5ï¸âƒ£ æ¨¡å—å¯¹åº”ç›®å½•,æ”¹æ‰€æœ‰è€… 6ï¸âƒ£ é‡å¯æœåŠ¡
:::
#

### æ ¹æ®æµç¨‹æ‰¾å‡ºå‘½ä»¤(ans-æ¨¡å—)
åˆ‡è®°æ˜¯ç®¡ç†æœºå™¨ä¸Šæ“ä½œçš„

| éƒ¨ç½²rsyncæœåŠ¡ç«¯ | å‘½ä»¤ |
| --- | --- |
| æœåŠ¡éƒ¨ç½²:yum å®‰è£…æˆ–æ›´æ–° | yum install -y rsync |
| é…ç½®æ–‡ä»¶ | å…ˆå‡†å¤‡å¥½é…ç½®æ–‡ä»¶,scp ä¼ è¾“åˆ°rsyncæœåŠ¡å™¨ä¸Šé¢. |
| è™šæ‹Ÿç”¨æˆ· rsync | useradd -s /sbin/nologin -M rsync |
| å¯†ç æ–‡ä»¶å’Œæƒé™ | echo 'rsync_backup:1' >/etc/rsync.password ç„¶å ä¿®æ”¹æƒé™chmod 600 /etc/rsync.password |
| æ¨¡å—å¯¹åº”ç›®å½•,æ”¹æ‰€æœ‰è€… | mkdir -p /data && chown rsync.rsync /data |
| é‡å¯æœåŠ¡ | systemctl start rsyncd && systemctl enable rsyncd
  |
  
### æ ¹æ®é€‰æ‹©çš„æ¨¡å—å®ç°å¯¹åº”çš„åŠŸèƒ½

#### æœåŠ¡éƒ¨ç½² yum å®‰è£…æˆ–æ›´æ–°

```
ansible backup     -m yum     -a 'name=rsync state=lastest'
```
#### é…ç½®æ–‡ä»¶åˆ†å‘

```
mkdir -p /server/ans/pro-rsync
å‡†å¤‡é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨ ä¸Šé¢ç›®å½•ä¸­ rsyncd.conf 
ansible backup     -m copy     -a 'src=/server/ans/pro-rsync/rsyncd.conf dest=/etc/rsyncd.conf backup=yes'
```
####  è™šæ‹Ÿç”¨æˆ· rsync

```
ansible backup -m user -a 'name=rsync shell=/sbin/nologin create_home=no state=present'
```
#### å¯†ç æ–‡ä»¶å’Œæƒé™

```
åˆ›å»ºæ–‡ä»¶
ansible backup -m file -a 'path=/etc/rsync.password      mode=600 state=touch'
å¢åŠ 
ansible backup -m lineinfile      -a 'path=/etc/rsync.password line="rsync_backup:1"'
```
#### æ¨¡å—å¯¹åº”ç›®å½•,æ”¹æ‰€æœ‰è€…

```
ansible backup -m file -a 'path=/data  owner=rsync group=rsync state=directory'
```
####  é‡å¯æœåŠ¡

```
ansible backup -m systemd -a 'name=rsyncd enabled=yes state=started'
```
#### å‘½ä»¤è¡Œæµ‹è¯•

```
[root@m01 /server/ans/pro-rsync]# rsync -av /etc/hostname  rsync_backup@172.16.1.31:/data 
Password: 
sending incremental file list
hostname
sent 101 bytes received 43 bytes 57.60 bytes/sec
total size is 4 speedup is 0.03
[root@m01 /server/ans/pro-rsync]#
```
#### æŒ‡å®šhostsæ–‡ä»¶çš„ä½ç½®

```
tree /server/ans/pro-rsync/ /server/ans/pro-rsync/

â”œâ”€â”€ hosts
â””â”€â”€ rsyncd.conf
0 directories, 2 files

ansible -i hosts all -m ping
```

## æ€»ç»“

:::tip{title="æç¤º"}
 ä»…ç”¨äºå±•ç¤º,æœªæ¥æ‰¹é‡ç®¡ç†rsynæœåŠ¡æˆ–å…¶ä»–æœåŠ¡,è¦ä½¿ç”¨ansible playbook å‰§æœ¬

è¿™ä¸ªåªæ˜¯ç”¨æ¥æŒæ¡éƒ¨ç½²æŸä¸ªæœåŠ¡çš„æµç¨‹
:::

## Ansible-playbook(å‰§æœ¬)


:::info{title="ç›¸å…³ä¿¡æ¯"}
æˆ‘ä»¬ä½œä¸ºå¯¼æ¼”,ç¼–æ’ä¸€å‡ºæˆ. é€šè¿‡ä½ è®¾ç½®æ­¥éª¤,è®©æ¼”å‘˜åšå¯¹åº”åŠ¨ä½œæ“ä½œ. å‰§æœ¬æ ¸å¿ƒ:æŒ‡å®šä¸»æœº,æ‰§è¡Œä»€ä¹ˆä»»åŠ¡(æ¨¡å—),ä»€ä¹ˆæ“ä½œ(é€‰é¡¹)
:::

### ansible ad-hoc vs playbookåŒºåˆ«

![20241129233250](https://liu-fu-gui.github.io/myimg/halo/20241129233250.png)
### playbook vs shellè„šæœ¬

| å‰§æœ¬ä¸è„šæœ¬ | åº”ç”¨åœºæ™¯ |
| --- | --- |
| playbookå‰§æœ¬ | æ‰¹é‡ç®¡ç†,æ‰¹é‡éƒ¨ç½²,æ‰¹é‡åˆ†å‘... |
| shellè„šæœ¬ | æŸä¸€å°,æœåŠ¡è„šæœ¬,ç³»ç»Ÿå·¡æ£€,å®šæ—¶å¤‡ä»½... |

## Playbookå‰§æœ¬æé€Ÿä½¿ç”¨æŒ‡å—
- å‰§æœ¬æ ¼å¼å«yamlæ ¼å¼yml.
- ç¼©è¿›,ä¸è¦ç”¨tabé”®,ç©ºæ ¼.


![20241129233301](https://liu-fu-gui.github.io/myimg/halo/20241129233301.png)


:::tip{title="æç¤º"}
æ ¸å¿ƒæ ¼å¼å‰§æœ¬ä¸­æ‰€æœ‰çš„å†…å®¹è¦å¯¹é½ å¯¹é½çš„æ—¶å€™ä¸èƒ½ä½¿ç”¨tabé”®. åªèƒ½ä½¿ç”¨ç©ºæ ¼,2ä¸ªç©ºæ ¼. hostsç”¨äºæŒ‡å®šåœ¨å“ªäº›ä¸»æœºæ‰§è¡ŒæŒ‡ä»¤ tasks: ç”¨äºå¯¹äºè¿™äº›ä¸»æœº,è¿è¡Œä»€ä¹ˆæ¨¡å—åŠé€‰é¡¹
:::
### æ¡ˆä¾‹01:åœ¨æ‰€æœ‰æœºå™¨çš„/tmpä¸‹é¢åˆ›å»ºlidao.txt

```
--------- æ‰§è¡Œå‰§æœ¬-------------
cat 01.touch.yml 
- hosts: all
 vars:
  filename: lidao.txt
 tasks:
   - name: touch file
     shell: touch /tmp/{{ filename }}
 
cp /etc/ansible/hosts . 
ansible-playbook -i hosts 01.touch.yml 
 
--------- æ£€æŸ¥å‰§æœ¬-------------
tree /server/ans/playbook/
/server/ans/playbook/
â”œâ”€â”€ 01.touch.yml
â””â”€â”€ hosts
0 directories, 2 files


- hosts: all
  tasks:
    - name: touch file 
      shell: touch /tmp/lida.txt
```

### æ¡ˆä¾‹02:æ·»åŠ å®šæ—¶åŒæ­¥æ—¶é—´çš„å®šæ—¶ä»»åŠ¡
#### åŸå§‹å‘½ä»¤è¡Œansibleå‘½ä»¤

```
ansible all -m cron -a 'name="sync time by lidao996 20221111" minute="*/2" job="/sbin/ntpdate ntp1.aliyun.com &>/dev/null" state=present'
ansible -i hosts all -a 'crontab -l'
```
#### ä¿®æ”¹ä¸ºå‰§æœ¬ä¹‹å

```
#ç®€å•ç²—æš´ç‰ˆæœ¬
---
- hosts: all
  tasks:
  - name: add cron sync time
    cron: 
      name="sync time by lidao996 20221111" 
      minute="*/2" 
      job="/sbin/ntpdate ntp1.aliyun.com &>/dev/null" 
      state=present
#æ ¼å¼ä¼˜åŒ–å
---
- hosts: all
  tasks:
    - name: add cron sync time
      cron: 
        name: "sync time by lidao996 20221111" 
        minute: "*/2" 
        job: "/sbin/ntpdate ntp1.aliyun.com &>/dev/null" 
        state: present
```

- ==åœ¨å‰§æœ¬ä¸­ä½¿ç”¨æ¨¡å—å’Œé€‰é¡¹==
- ==é€‰é¡¹æœ€å¥½æ˜¯ä¸€è¡Œä¸€ä¸ªé€‰é¡¹,é€‰é¡¹åé¢çš„è·Ÿç€å†’å·==
- ==é€‰é¡¹è¦å¯¹é½ä¸ç¼©è¿›==

![20241129233313](https://liu-fu-gui.github.io/myimg/halo/20241129233313.png)

#### æ£€æŸ¥
```
ansible -i hosts all  -a 'crontab -l'
```
### æ¡ˆä¾‹03-ä¼ä¸šæ¡ˆä¾‹-æ‰¹é‡ä¸‹è½½å®‰è£…zabbix-agent2-6.0å®¢æˆ·ç«¯å¹¶å¯åŠ¨

#### zabbix-agent2å®¢æˆ·ç«¯
- 1ï¸âƒ£ ä¸‹è½½rpmåŒ…
- 2ï¸âƒ£ å®‰è£…rpmåŒ…
- 3ï¸âƒ£ å¯åŠ¨æœåŠ¡zabbix-agent2


| zabbix-agent2å®¢æˆ·ç«¯ | å‘½ä»¤å’Œæ¨¡å— |
| --- | --- |
| ä¸‹è½½rpmåŒ… | wget get_url |
| å®‰è£…rpmåŒ… | rpm/yum yum |
| å¯åŠ¨æœåŠ¡zabbix-agent2 | systemctl systemd |


#### æ¨¡å—å¯¹åº”å‘½ä»¤

```
---
- hosts: all
  tasks:
    - name: 1. download zabbix agent2 rpm
      get_url:
        ur: https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/6.0/rhel/7/x86_64/zabbix-agent2-6.0.0-1.el7.x86_64.rpm
        dest: /tmp/
        validate_certs: no
    - name: 2. install zabbix agent2 rpm
      yum:
        name: /tmp/zabbix-agent2-6.0.0-1.el7.x86_64.rpm
        state: installed
    - name: 3. start  zabbix agent2 service
      systemd:
        name: zabbix-agent2
        enabled: yes
        state: started
```

### æ¡ˆä¾‹04-éƒ¨ç½²rsyncæœåŠ¡ç«¯ï¼ˆå‰§æœ¬ï¼‰
å‡†å¤‡ï¼šå½“å‰ç›®å½•ä¸­åŒ…å«ï¼Œrsyncd.confé…ç½®æ–‡ä»¶

```
### 1) æœåŠ¡éƒ¨ç½²:yum å®‰è£…æˆ–æ›´æ–°
ansible backup -m yum -a 'name=rsync state=lastest'
### 2) é…ç½®æ–‡ä»¶åˆ†å‘
mkdir -p /server/ans/pro-rsync
å‡†å¤‡é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨ ä¸Šé¢ç›®å½•ä¸­ rsyncd.conf 
ansible backup -m copy -a 'src=/server/ans/pro-rsync/rsyncd.conf dest=/etc/rsyncd.conf backup=yes'
### 3) è™šæ‹Ÿç”¨æˆ· rsync
ansible backup -m user -a 'name=rsync 
shell=/sbin/nologin create_home=no state=present'
### 4)å¯†ç æ–‡ä»¶å’Œæƒé™
åˆ›å»ºæ–‡ä»¶
ansible backup -m file -a 'path=/etc/rsync.password mode=600 state=touch'
å¢åŠ 
ansible backup -m lineinfile  -a'path=/etc/rsync.password line="rsync_backup:1"'
### 5)æ¨¡å—å¯¹åº”ç›®å½•,æ”¹æ‰€æœ‰è€…
ansible backup -m file -a 'path=/data  owner=rsync group=rsync state=directory'
### 6) é‡å¯æœåŠ¡
ansible backup -m systemd -a 'name=rsyncd enabled=yes state=started'

[root@m01 /server/ans/playbook]# ansible -i hosts backup -m ping 
172.16.1.41 | SUCCESS => {
 "ansible_facts": {
   "discovered_interpreter_python": "/usr/bin/python"
 }, 
 "changed": false, 
  "ping": "pong"
}


[root@m01 /server/ans/playbook]# cat 05-backup-resyncd.yml 
---
- hosts: backup
  tasks:
    - name: 1) æœåŠ¡éƒ¨ç½²:yum å®‰è£…æˆ–æ›´æ–°
      yum:---
- hosts: backup
  tasks:
    - name: 1) æœåŠ¡éƒ¨ç½²:yum å®‰è£…æˆ–æ›´æ–°
      yum:
#    name: rsync 
#    state: latest
   
    - name: 2) é…ç½®æ–‡ä»¶åˆ†å‘
      copy: 
        src: /server/ans/playbook/rsyncd.conf
        dest: /etc/rsyncd.conf 
        backup: yes
   
    - name: 3) è™šæ‹Ÿç”¨æˆ· rsync
      user: 
        name: rsync 
        shell: /sbin/nologin 
        create_home: no 
        state: present 
    
    - name: 4) å¯†ç æ–‡ä»¶å’Œæƒé™
      lineinfile:  
        path: /etc/rsync.password 
        mode: 0600
        line: "rsync_backup:1"
        create: yes
   
    - name: 5) æ¨¡å—å¯¹åº”ç›®å½•,æ”¹æ‰€æœ‰è€…
      file:
        path: /data/
        owner: rsync 
        group: rsync
        state: directory
    
    - name: 6) é‡å¯æœåŠ¡
      systemd: 
        name: rsyncd
        enabled: yes
        state: started
```

## Ansibleå‘½ä»¤æ€»ç»“ä¸è®°å½•
ansible-playbookå‘½ä»¤æ ¼å¼


:::warning{title="æ³¨æ„"}
æ ¼å¼ï¼šansible-playbook -i æŒ‡å®šä¸»æœºæ¸…å•æ–‡ä»¶ [é€‰é¡¹] ymlæ–‡ä»¶

é€‰é¡¹ï¼š\
-i ï¼šæŒ‡å®šä¸»æœºæ¸…å•æ–‡ä»¶\
-C : æ¨¡æ‹Ÿè¿è¡Œå‰§æœ¬ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰é—®é¢˜\
--syntax-check :ä»…ä»…æ£€æŸ¥å‰§æœ¬æ ¼å¼æ˜¯å¦æœ‰è¯¯
:::
# æ›´æ·±å…¥çš„ä¸œè¥¿ï¼Œçœ‹ä¸æ‡‚å°±ä¸ç”¨çœ‹äº†
## æ¡ˆä¾‹06-éƒ¨ç½²nfsæœåŠ¡ç«¯å…¨æµç¨‹


![20241129233332](https://liu-fu-gui.github.io/myimg/halo/20241129233332.png)
### Ansible-å˜é‡ç³»åˆ—
#### å˜é‡

- å‘½ä»¤è¡Œ : ä¸´æ—¶ä½¿ç”¨,è¾ƒå°‘ç”¨.
- å˜é‡æ–‡ä»¶vars_files : æŸä¸€ä¸ªä¸»æœºä½¿ç”¨,è¾ƒå°‘ç”¨.
- ä¸»æœºç»„å…±ç”¨çš„å˜é‡æ–‡ä»¶ group_vars : åº”ç”¨èŒƒå›´å¹¿æ³›.
- ansibleå†…ç½®å˜é‡(factså˜é‡) : æ”¶é›†ä¸»æœºçš„åŸºæœ¬ä¿¡æ¯,ipåœ°å€,ä¸»æœºå,ç³»ç»ŸåŠç‰ˆæœ¬....
- registerå˜é‡ : å®ç°å‘½ä»¤è¡Œ $() æˆ– `` åŠŸèƒ½

#### å˜é‡è¯¦è§£
##### vars,vars_files , group_vars
###### å‰§æœ¬ä¸­å®šä¹‰å˜é‡ â­ â­ â­ â­ â­

```
cat 07.vars_dir.yml 
---
- hosts: all
  vars:
    dir_name: /oldboy_lidao
    file_name: lidao996.icu
  tasks:
    - name: 01. mkdir
      file:
        path: "{{ dir_name }}"
        state: directory
  - name: 02. touch
    file:
      path: "{{ dir_name }}/{{ file_name }}"
      state: touch
```
###### æŠŠå˜é‡å­˜æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­. å‰§æœ¬æ¯”è¾ƒå¤§çš„æ—¶å€™

```
cat vars.yml 
dir_name: /xiaoliu
file_name: xiaoliu.æˆ‘çˆ±ä½ 

cat 08.vars_files_dir.yml
---
- hosts: all
  vars_files: ./vars.yml
  tasks:
    - name: 01. mkdir
      file:
        path: "{{ dir_name }}"
        state: directory

    - name: 02. touch
      file:
        path: "{{ dir_name }}/{{ file_name }}"
        state: touch
```

###### åˆ›å»ºä¸€ä¸ªå˜é‡æ–‡ä»¶,ç»™æŸä¸ªç»„å…±ç”¨â­ â­ â­ â­ â­

```
ç”¨æ³•:éœ€è¦åˆ›å»ºä¸€ä¸ªgroup_varsç›®å½•
   ç›®å½•ä¸‹é¢åˆ›å»ºä»¥ä¸»æœºç»„å‘½åçš„ç›®å½•
   å­˜æ”¾å˜é‡æ–‡ä»¶vars.yml
   
group_vars/ ç›®å½•
   lb/vars.yml  #å­˜æ”¾lbç»„çš„å˜é‡
   web/vars.yml #å­˜æ”¾webç»„çš„å˜é‡
   data/vars.yml #å­˜æ”¾xxxç»„çš„å˜é‡
   all/vars.yml  #æ‰€æœ‰ä¸»æœºå…±ç”¨çš„å˜é‡
```
### æ¡ˆä¾‹01-æ ¹æ®ä¸åŒçš„ä¸»æœºç»„åˆ›å»ºå¯¹åº”çš„ç›®å½•.

```
group_vars/ ç›®å½•
  web/vars.yml #å­˜æ”¾webç»„çš„å˜é‡
  data/vars.yml #å­˜æ”¾xxxç»„çš„å˜é‡
  all/vars.yml #æ‰€æœ‰ä¸»æœºå…±ç”¨çš„å˜é‡
webæœåŠ¡å™¨åˆ›å»º /app/code/ç›®å½•
dir_name: /app/code/
dataæœåŠ¡ç«¯åˆ›å»º /data/ç›®å½•
dir_name: /data/
#å‚è€ƒ:

##å˜é‡æ–‡ä»¶å†…å®¹
[root@m01 /server/ans/playbook]$ cat group_vars/data/vars.yml 
dir_name: /datav2/

[root@m01 /server/ans/playbook]$ cat group_vars/web/vars.yml 
dir_name: /app/code/    #å†’å·ï¼šåé¢ä¸€å®šè¦åŠ ç©ºæ ¼

[root@m01 /server/ans/playbook]# tree group_vars/
group_vars/
â”œâ”€â”€ data
â”‚ â””â”€â”€ vars.yml
â””â”€â”€ web
  â””â”€â”€ vars.yml
3 directories, 3 files
#å‰§æœ¬å†…å®¹
[root@m01 /server/ans/playbook]$ cat 09.vars_group_vars_dir.yml
- hosts: all
  tasks:
    - name: æ ¹æ®ä¸»æœºåˆ›å»ºä¸åŒçš„ç›®å½•
      file:
        path: "{{ dir_name }}"
        state: directory
```
#### group_varsæœªæ¥åº”ç”¨åœºæ™¯:ä½¿ç”¨allç»Ÿä¸€å­˜æ”¾å˜é‡
### æ¡ˆä¾‹02-ä½¿ç”¨group_varsçš„allç»„å®šä¹‰å˜é‡.â­â­â­â­â­

```
[root@m01 /server/ans/playbook]$ tree group_vars/
group_vars/
â”œâ”€â”€ all
â”‚ â””â”€â”€ vars.yml
â”œâ”€â”€ data
â”‚ â””â”€â”€ vars.yml
â””â”€â”€ web
  â””â”€â”€ vars.yml
3 directories, 3 files

[root@m01 /server/ans/playbook]$ cat group_vars/all/vars.yml 
dir_name_code: /app/code/
dir_name_data: /data/ 

[root@m01 /server/ans/playbook]$ cat > 09.vars_group_vars_dir.yml  <<'EOF'
- hosts: all
  tasks:
    - name: 01 {{ dir_name_code }}
      file:
        path: "{{ dir_name_code }}"
        state: directory

    - name: 02 {{ dir_name_data }}
      file:
        path: "{{ dir_name_data }}"
        state: directory
EOF
        
å‰§æœ¬ç›®å½•,ç›®å½•ç»“æ„
[root@m01 /server/ans/playbook]$ tree 
.
â”œâ”€â”€ 01.touch.yml
â”œâ”€â”€ 02.add-cron.yml
â”œâ”€â”€ 03.add-cron-you.yml
â”œâ”€â”€ 04.install-zabbix-agent2.yml
â”œâ”€â”€ 05-backup-resyncd.yml
â”œâ”€â”€ 06-nfs-server.yml
â”œâ”€â”€ 07.vars_dir.yml
â”œâ”€â”€ 08.vars_files_dir.yml
â”œâ”€â”€ 09.vars_group_vars_dir.yml
â”œâ”€â”€ group_vars
â”‚   â”œâ”€â”€ all
â”‚   â”‚   â””â”€â”€ vars.yml
â”‚   â”œâ”€â”€ data
â”‚   â”‚   â””â”€â”€ vars.yml
â”‚   â””â”€â”€ web
â”‚       â””â”€â”€ vars.yml
â”œâ”€â”€ hosts
â”œâ”€â”€ rsyncd.conf
â””â”€â”€ vars.yml
4 directories, 15 files
```

### å˜é‡åŸºç¡€å®šä¹‰å°ç»“


| ä½¿ç”¨æ–¹æ³• | å«ä¹‰å’Œåº”ç”¨åœºæ™¯ |
| --- | --- |
| å˜é‡å†™åœ¨å‰§æœ¬å¼€å¤´ | vars: ç®€å•çš„è¾ƒå°‘çš„ä¸€ç§ |
| å˜é‡å†™åœ¨ç‹¬ç«‹æ–‡ä»¶ä¸­: | vars_files: æŒ‡å®šå˜é‡æ–‡ä»¶ä½ç½® äº†è§£ä¸ºä¸» |
| å˜é‡å†™åœ¨ç‹¬ç«‹æ–‡ä»¶ä¸­,æŒ‰ç…§ç»„è¿›è¡Œåˆ†ç±»: | group_vars/ç›®å½• all/vars.yml æŒæ¡åœ¨allä¸­åˆ›å»ºæ‰€æœ‰ä¸»æœº/åˆ†ç»„ç”¨çš„å˜é‡å³å¯|
### ansible-factså˜é‡
factså˜é‡è¯´æ˜ : ansibleå†…ç½®å˜é‡,æ‰§è¡Œå‰§æœ¬,æœ‰ä¸ªé»˜è®¤çš„ä»»åŠ¡(task),æ”¶é›†æ¯ä¸ªä¸»æœºçš„åŸºæœ¬ä¿¡æ¯.

:::tip{title="æç¤º"}
ansible_factsæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å˜é‡ï¼Œå®ƒåŒ…å«äº†å…³äºç›®æ ‡ä¸»æœºçš„ç³»ç»Ÿä¿¡æ¯å’Œå…¶ä»–æœ‰ç”¨çš„ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯ç”±Ansibleåœ¨æ‰§è¡Œä»»åŠ¡æ—¶è‡ªåŠ¨æ”¶é›†å¹¶å­˜å‚¨åœ¨ansible_factså˜é‡ä¸­ï¼Œä½ å¯ä»¥åœ¨åç»­çš„ä»»åŠ¡ä¸­ä½¿ç”¨è¿™äº›ä¿¡æ¯
:::


```
#æŸ¥çœ‹ ansible factså˜é‡å†…å®¹
ansible -i hosts web  -m setup

å¸¸ç”¨factå˜é‡
ansible_hostname        #ä¸»æœºå
ansible_memtotal_mb      #å†…å­˜å¤§å°(æ€»è®¡) å•ä½mb 
ansible_processor_vcpus    #cpuæ•°é‡
ansible_default_ipv4.address  #é»˜è®¤çš„ç½‘å¡ip eth0
ansible_distribution      #ç³»ç»Ÿå‘è¡Œç‰ˆæœ¬åå­—
  
  CentOS Ubuntu Debian ...
ansible_processor_cores    #æ ¸å¿ƒæ€»æ•°
ansible_date_time.date     #å½“å‰æ—¶é—´ å¹´-æœˆ-æ—¥
```
### æ¡ˆä¾‹01-ç³»ç»Ÿå·¡æ£€-è·å–æ‰€æœ‰æœºå™¨çš„åŸºç¡€ä¿¡æ¯ä¿å­˜åˆ°/tmp/ä¸»æœºåå‘½åæ–‡ä»¶ä¸­.

```
æ­¥éª¤: 
01.åˆ›å»ºæ–‡ä»¶
02.å†™å…¥å†…å®¹
[root@m01 /server/ans/playbook]$ cat 10.vars_sys_info.yml
---
- hosts: all
  tasks:
    - name: åˆ›å»ºæ–‡ä»¶å¹¶å†™å…¥ç³»ç»ŸåŸºæœ¬ä¿¡æ¯
      lineinfile:
        path: /tmp/{{ ansible_hostname }}
        create: yes
        line: "ä¸»æœºå: {{ ansible_hostname }}\n ipåœ°å€: {{ ansible_default_ipv4.address }}\nå†…å­˜æ€»è®¡: {{ ansible_memtotal_mb }}"
```


:::danger{title="factså°ç»“"}
å¦‚æœansä¸­ä½¿ç”¨åˆ°äº†ä¸€äº›ç³»ç»Ÿçš„åŸºç¡€ä¿¡æ¯. eg: ipåœ°å€,ä¸»æœºå,æ—¶é—´.

å¦‚æœæ²¡æœ‰è¿™ç§éœ€æ±‚æˆ–é€šè¿‡åˆ«çš„æ–¹å¼å®ç°è¿™ä¸ªéœ€æ±‚,å¯ä»¥å…³é—­factsåŠŸèƒ½,è®©å‰§æœ¬æ‰§è¡ŒåŠ é€Ÿ. ä½¿ç”¨gather_facts: no
:::


```
---
- hosts: all
  gather_facts: no
  vars:
    dir_name: /oldboy_lidao
    file_name: lidao996.icu
  tasks:
    - name: 01. mkdir
      file:
        path: "{{ dir_name }}"
        state: directory

    - name: 02. touch
      file:
        path: "{{ dir_name }}/{{ file_name }}"
        state: touch
```

#### ansible-registerå˜é‡

:::tip{title="æç¤º"}
registerå˜é‡ç”¨äºå­˜å‚¨ä»»åŠ¡æ‰§è¡Œçš„ç»“æœã€‚é€šè¿‡å°†registerå…³é”®å­—ä¸ä¸€ä¸ªå˜é‡åç»“åˆä½¿ç”¨ï¼Œå¯ä»¥å°†ä»»åŠ¡çš„è¾“å‡ºä¿å­˜åˆ°è¯¥å˜é‡ä¸­ï¼Œä»¥ä¾¿åç»­çš„ä»»åŠ¡å¯ä»¥ä½¿ç”¨
:::
åˆ›å»ºå‹ç¼©åŒ…å‹ç¼©åŒ…åå­—åŒ…å«æ—¶é—´. taræ‰“åŒ…å‹ç¼©,dateè·å–æ—¶é—´.

```
tar zcf /tmp/etc-`date +%F`.tar.gz /etc/
```
#### æ¡ˆä¾‹01-åˆ›å»ºä»¥ä¸»æœºåå‘½åæ–‡ä»¶/opt/ä¸»æœºå

```
æ­¥éª¤:
01.è·å–ä¸»æœºå:hostname
02.åˆ›å»ºæ–‡ä»¶,ä½¿ç”¨ä¸Šä¸€æ­¥çš„ç»“æœ
register: å˜é‡åå­— #è¿™ä¸ªå˜é‡çš„å†…å®¹,å«jsonæ ¼å¼.
register: hostname #jsonæ ¼å¼,åªæƒ³è¦è¾“å‡ºæ ‡å‡†è¾“å‡º stdout 
standard output æ ‡å‡†è¾“å‡º.
hostname.stdout #å–å‡ºå‘½ä»¤çš„ç»“æœ `hostname`

[root@m01 /server/ans/playbook]# cat 12.vars_register.yml
---
- hosts:
  tasks:
    - name: 01.è·å–ä¸»æœºå
      shell: hostname
      register: hostname
    - name: è¾“å‡ºå˜é‡å†…å®¹
      debug: 
        msg: "{{ hostname }}" 

[root@m01 /server/ans/playbook]# cat  12.vars_register.yml 
---
- hosts: all
  tasks:
    - name: 01.è·å–ä¸»æœºå
      shell: hostname
      register: hostname
    - name: è¾“å‡ºå˜é‡å†…å®¹
      debug: 
        msg: "{{ hostname.stdout }}"
    - name: 02. åˆ›å»ºæ–‡ä»¶
      file:
        path: /opt/{{ hostname.stdout }}
        state: touch
```

registerå˜é‡è¾“å‡ºç»“æœ

```
{
 "msg": {
    "changed": true, 
    "cmd": "hostname", 
    "delta": "0:00:00.008150", 
    "end": "2022-04-14 12:32:14.587547", 
    "failed": false, 
    "rc": 0,         #å‘½ä»¤çš„è¿”å›å€¼,0è¡¨ç¤ºæ­£ç¡®,é0é”™è¯¯.
    "start": "2022-04-14 12:32:14.579397", 
    "stderr": "",       #é”™è¯¯ä¿¡æ¯
    "stderr_lines": [], 
    "stdout": "backup02",  #è¿™ä¸ªæœ€å¸¸ç”¨. å‘½ä»¤çš„ç»“æœ,è¾“å‡º
    "stdout_lines": [
      "backup02"
    ]
  }
}

register: hostname 
hostname.stdout #æ­£å¸¸è¾“å‡ºä¿¡æ¯
hostname.rc   #å–å‡ºè¿”å›å€¼.
hostname.stderr #å–å‡ºé”™è¯¯ä¿¡æ¯.
```

## å˜é‡å°ç»“
ä¸ºä½•ä½¿ç”¨å˜é‡:

å‰§æœ¬,è„šæœ¬ä½¿ç”¨çš„å˜é‡æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­,å‰§æœ¬å¼€å¤´çš„.

ä¸€èˆ¬å­˜æ”¾: ç”¨æˆ·å,ç”¨æˆ·ç»„,ç›®å½•,ç«¯å£......

![20241129233403](https://liu-fu-gui.github.io/myimg/halo/20241129233403.png)

# Ansible-è¿›é˜¶-å‰§æœ¬è°ƒè¯•æ–¹æ³•

:::info{title="æ¦‚è¿°"}
debugæ¨¡å—

tags æ ‡ç­¾

å¿½ç•¥é”™è¯¯
:::

## Debugæ¨¡å—
- msg : ç›¸å½“äºæ˜¯echo å‘½ä»¤,é…åˆç€registerä¸€èµ·ç”¨
### æ¡ˆä¾‹01-è°ƒè¯•-nfsæœåŠ¡ç«¯éƒ¨ç½²å‰§æœ¬

```
[root@m01 /server/ans/playbook]$ cat  13-debug-nfs-server.yml 
---
- hosts: db
  tasks:
    - name: 01. éƒ¨ç½²nfsæœåŠ¡ç«¯è½¯ä»¶
      yum:
        name: nfs-utils
        state: installed
    
    - name: 02. ä¿®æ”¹é…ç½®æ–‡ä»¶
      lineinfile:
        path: /etc/exports
        line: "/data  172.16.1.0/24(rw)"
        state: present
        backup: yes
   
    - name: 03. åˆ›å»ºå¯¹åº”çš„ç›®å½•,æƒé™
      file:
        path: /data/ 
        owner: nfsnobody
        group: nfsnobody
        state: directory
      register: file_jieguo

    - name: è¾“å‡º,æ˜¾ç¤ºè¿™ä¸ªè¿‡ç¨‹
      debug:
        msg: "{{ file_jieguo }}"
    
    - name: 04. å¯åŠ¨æœåŠ¡-rpcæœåŠ¡
      systemd:
        name: rpcbind
        enabled: yes
        state: started
    
    - name: 05. å¯åŠ¨æœåŠ¡-nfsæœåŠ¡
      systemd:
        name: nfs
        enabled: yes
        state: started
```
### tagsæ ‡ç­¾
- ä¸€èˆ¬ç”¨äºè°ƒè¯•å‰§æœ¬,ç»™å‰§æœ¬çš„æ¯ä¸ªtaskå¯ä»¥è®¾ç½®ä¸ªæ ‡ç­¾. è¿è¡Œå‰§æœ¬çš„æ—¶å€™å¯ä»¥**è¿è¡ŒæŒ‡å®šæ ‡ç­¾. è¿è¡Œå‰§æœ¬çš„æ—¶å€™æ’é™¤æŸäº›æ ‡ç­¾**.


```
[root@m01 /server/ans/playbook]$ cat 14-tags-nfs-server.yml 
---
- hosts: db
  tasks:
    - name: 01. éƒ¨ç½²nfsæœåŠ¡ç«¯è½¯ä»¶
      yum:
        name: nfs-utils
        state: installed
      tags:
        - install
    
    - name: 02. ä¿®æ”¹é…ç½®æ–‡ä»¶
      lineinfile:
        path: /etc/exports
        line: "/data  172.16.1.0/24(rw)"
        state: present
        backup: yes
      tags:
        - conf
        - conf_file
    
    - name: 03. åˆ›å»ºå¯¹åº”çš„ç›®å½•,æƒé™
      file:
        path: /data/ 
        owner: nfsnobody
        group: nfsnobody
        state: directory
      tags:
        - conf
        - conf_dir

    - name: 04. å¯åŠ¨æœåŠ¡-rpcæœåŠ¡
      systemd:
        name: rpcbind
        enabled: yes
        state: started
      tags:
        - start_srv 
    - name: 05. å¯åŠ¨æœåŠ¡-nfsæœåŠ¡
      systemd:
        name: nfs
        enabled: yes
        state: started
      tags:
        - start_srv
```

#### è¿è¡ŒæŒ‡å®šçš„æ ‡ç­¾

```
ansible-playbook -i hosts  --tags conf 14-tags-nfs-server.yml 
ansible-playbook -i hosts  --tags conf_file,conf_dir 14-tags-nfs-server.yml
```
#### è¿è¡Œå‰§æœ¬çš„æ—¶å€™æ’é™¤æŒ‡å®šçš„æ ‡ç­¾

```
ansible-playbook -i hosts - ---skip-tags install,conf_file 14-tags-nfs-server.yml
```

###  å¿½ç•¥é”™è¯¯

:::info{title="ignore_errors: yes"}
ç”¨äºè¿è¡Œå‰§æœ¬çš„æ—¶å€™,å¼ºåˆ¶è®©æŸä¸ªä»»åŠ¡(æ¨¡å—)è¿è¡Œå³ä½¿å‡ºé”™äº†,ä¹Ÿä¸è¦ä¸­æ–­æˆ‘ä»¬çš„å‰§æœ¬
:::

```
[root@m01 /server/ans/playbook]$ cat 15-ignore-nfs-server.yml 
---
- hosts: db
  tasks:
    - name: 01. éƒ¨ç½²nfsæœåŠ¡ç«¯è½¯ä»¶
      yum:
        name: nfs-util
        state: installed
      ignore_errors: yes
      tags:
        - install
    
    - name: 02. ä¿®æ”¹é…ç½®æ–‡ä»¶
      lineinfile:
        path: /etc/exports
        line: "/data  172.16.1.0/24(rw)"
        state: present
        backup: yes
      tags:
        - conf
        - conf_file
   
    - name: 03. åˆ›å»ºå¯¹åº”çš„ç›®å½•,æƒé™
      file:
        path: /data/ 
        owner: nfsnobody
        group: nfsnobody
        state: directory
      tags:
        - conf
        - conf_dir

    - name: 04. å¯åŠ¨æœåŠ¡-rpcæœåŠ¡
      systemd:
        name: rpcbind
        enabled: yes
        state: started
      tags:
        - start_srv
    
    - name: 05. å¯åŠ¨æœåŠ¡-nfsæœåŠ¡
      systemd:
        name: nfs
        enabled: yes
        state: started
      tags:
        - start_srv
```
## è°ƒè¯•æ–¹æ³•å°ç»“

| å…·ä½“æ–¹æ³• | åº”ç”¨åœºæ™¯ |
| --- | --- |
| debugæ¨¡å— | æ‰§è¡Œå‰§æœ¬çš„æ—¶å€™è¾“å‡ºå‰§æœ¬çš„æ‰§è¡Œæµç¨‹,ä¸€èˆ¬é…åˆregisterä¸€èµ·ä½¿ç”¨. è¾“å‡ºfactså˜é‡.è‡ªå®šä¹‰å˜ |
| tags æ ‡ç­¾ | ç»™ä¸€äº›æ¨¡å—åŠ ä¸Šæ ‡ç­¾,è¿è¡Œå‰§æœ¬çš„æ—¶å€™å¯ä»¥è¿è¡ŒæŒ‡å®šæ ‡ç­¾çš„å†…å®¹,æ’é™¤æŒ‡å®šæ ‡ç­¾ |
| å¿½ç•¥é”™è¯¯ | è¿è¡Œå‰§æœ¬çš„æ—¶å€™å¿½ç•¥ä¸€äº›æ¨¡å—çš„é”™è¯¯,è®©å‰§æœ¬ç»§ç»­è¿è¡Œ |
# Ansible-è¿›é˜¶-è¿›é˜¶åº”ç”¨
- include
- handler
- whenåˆ¤æ–­
- å¾ªç¯

## includeåŠŸèƒ½-ç†Ÿæ‚‰

:::tip{title="æç¤º"}
includeæ–‡ä»¶åŒ…å«.æŠŠä¸€ä¸ªä»»åŠ¡åˆ†æˆå¤šä¸ªå‰§æœ¬æ¥å®ç°,ä¹¦å†™ä¸ªæ€»å‰§æœ¬æ–‡ä»¶,é€šè¿‡include_tasks: å¼•ç”¨å­å‰§æœ¬æ–‡ä»¶
:::

![20241129233419](https://liu-fu-gui.github.io/myimg/halo/20241129233419.png)

## handlers â­â­â­â­â­
- ==handler è§¦å‘å™¨ï¼ˆæ¡ä»¶ï¼‰ï¼Œæ»¡è¶³æ¡ä»¶åå†åšä»€ä¹ˆäº‹æƒ…==

- åº”ç”¨åœºæ™¯ï¼šæƒ³è¡¨ç¤ºï¼šé…ç½®æ–‡ä»¶å˜åŒ–ï¼Œå†é‡å¯æœåŠ¡

- é…ç½®handlersä¹‹å‰ï¼Œæ¯æ¬¡è¿è¡Œå‰§æœ¬éƒ½ä¼šé‡å¯nfsï¼Œæ— è®ºé…ç½®æ–‡ä»¶æ˜¯å¦å˜åŒ–


```
[root@m01 /server/ans/playbook]$ cat 17-handler-nfs-server.yml
---
- hosts: db
  tasks:
    - name: 01. åˆ†å‘é…ç½®æ–‡ä»¶
      copy:
        src: ./exports
        dest: /etc/exports
        backup: yes

    - name: 02. å¯åŠ¨æœåŠ¡-nfsæœåŠ¡
      systemd:
        name: nfs
        enabled: yes
        state: restarted
```

![20241129233435](https://liu-fu-gui.github.io/myimg/halo/20241129233435.png)

==é…ç½®äº†handerles,åªæœ‰æœåŠ¡é…ç½®æ–‡ä»¶å˜åŒ–äº†å†é‡å¯æœåŠ¡==ã€‚

```
---
- hosts: db
  tasks:
    - name: 01. åˆ†å‘é…ç½®æ–‡ä»¶
      copy:
        src: ./exports
        dest: /etc/exports
        backup: yes
      notify:        #é€šçŸ¥ï¼Œå½“è¿™ä¸ªcopyæ¨¡å—æ‰§è¡Œå®Œï¼Œå°±é€šçŸ¥æŒ‡å®šçš„æ¨¡å—åç§°ï¼Œè¿™é‡Œæ˜¯02. é‡å¯ nfs
        - 02. é‡å¯ nfs   

  handlers:
    - name: 02. é‡å¯ nfs
      systemd:
        name: nfs
        enabled: yes
        state: restarted
```

![20241129233449](https://liu-fu-gui.github.io/myimg/halo/20241129233449.png)


![20241129233456](https://liu-fu-gui.github.io/myimg/halo/20241129233456.png)

###  when(åˆ¤æ–­)

:::tip{title="æç¤º"}
whenæ˜¯ansibleä¸­çš„åˆ¤æ–­è¯­å¥(æ¡ä»¶è¯­å¥). å®ç°å¯¹äºæŸä¸ªæ¨¡å—åœ¨æ»¡è¶³æˆ–ä¸æ»¡è¶³xxxxxæ¡ä»¶ä¸‹å†æ‰§è¡Œ.

ç»™webæœåŠ¡å™¨æˆ–lbæœåŠ¡å™¨,é…ç½®nginx yumæº
:::


```
when: ( ansible_distribution  "Ubuntu" )  #å¦‚æœç³»ç»Ÿçš„å‘è¡Œç‰ˆæœ¬æ˜¯Ubuntuåˆ™ è¿è¡Œæ¨¡å— ansible_distribution ansible factså˜é‡
when: ( ansible_hostname is match("web|lb"))  #ä¸»æœºååŒ…å«webæˆ–lb é…ç½®nginxæº. 
when: ( ansible_hostname is not match("web|lb") )

cat nginx.repo

[nginx]
baseurl = http://nginx.org/packages/centos/$releasever/$basearch/
enabled = 1
gpgcheck = 0
name = nginx stable repo


[root@m01 /server/ans/playbook]$ cat 18-when-fenfa-nginx-yum.yml 
---
- hosts: all
  tasks:
    - name: é…ç½®lbæˆ–webçš„nginx yumæº 
      copy:
        src: ./nginx.repo
        dest: /etc/yum.repos.d/nginx.repo 
        backup: yes
      when: ( ansible_hostname is match("web|lb") )
```


:::tip{title="whenå°ç»“:"}
whenä¸€èˆ¬ä¸ansible factså˜é‡ä¸€èµ·ä½¿ç”¨,åˆ¤æ–­ä¸»æœº/åˆ¤æ–­ç³»ç»Ÿç±»å‹

whenä¹Ÿå¯ä»¥ä¸registerå˜é‡ ä¸€èµ·æ­é…
:::

## å¾ªç¯â­â­â­â­â­
æ‰¹é‡å¯åŠ¨,é‡å¯æœåŠ¡
### æ¡ˆä¾‹01-æ‰¹é‡é‡å¯æœåŠ¡:crond,nfs,rpcbind â­â­â­â­â­

æ²¡å­¦å¾ªç¯ä¹‹å‰ï¼Œé‡å¤å†™å¤šä¸ªé‡å¯æœåŠ¡


```
- name: 04. å¯åŠ¨æœåŠ¡-rpcæœåŠ¡
   systemd:
     name: crond
     enabled: yes
     state: started
    
- name: 04. å¯åŠ¨æœåŠ¡-rpcæœåŠ¡
  systemd:
    name: rpcbind
    enabled: yes
    state: started
    
- name: 05. å¯åŠ¨æœåŠ¡-nfsæœåŠ¡
  systemd:
    name: nfs
    enabled: yes
    state: started
```
ä½¿ç”¨å¾ªç¯åï¼Œå°±ä¸ç”¨é‡å¤å†™å¤šä¸ªäº†

```
[root@m01 /server/ans/playbook]# cat 19-item-restart-service.yml 
---
- hosts: nfs
  gather_facts: no
  tasks:
    - name: restart å¤šä¸ªæœåŠ¡
      systemd:
        name: "{{ item }}"
        state: restarted
      with_items:
        - crond
        - rpcbind
        - nfs
```

![20241129233544](https://liu-fu-gui.github.io/myimg/halo/20241129233544.png)

### æ¡ˆä¾‹02-å¾ªç¯æ·»åŠ ç”¨æˆ·å¹¶æŒ‡å®šuid â­
ansibleä¸­2ä¸ªæˆ–å¤šä¸ªå˜é‡çš„å¾ªç¯è¯­å¥æ ¼å¼.

| ç”¨æˆ·å | uid |
| --- | --- |
| lidao | 12307 |
| oldboy996 | 12580 |


```
- hosts: all
  gather_facts: no
  tasks:
    - name: æ‰¹é‡æ·»åŠ ç”¨æˆ·
      user:
        name: "{{ item.name }}"
        uid: "{{ item.uid }}"
        state: present 
      with_items:
        - { name: "lidao",   uid: "12307" }
        - { name: "oldboy996", uid: "12580" }
```

![20241129233557](https://liu-fu-gui.github.io/myimg/halo/20241129233557.png)


:::tip{title="Anså¾ªç¯å°ç»“:"}
with_items: å®ç°å¾ªç¯,å˜é‡åå­—itemâ€‹ å¤šä¸ªå˜é‡å¾ªç¯äº†è§£å³å¯.

â€‹ æ³¨:è¿™é‡Œçš„with_itemså¯ä»¥æ›¿æ¢æˆloop.

:::

##  Jinja2æ¨¡æ¿

:::info{title="ç›¸å…³ä¿¡æ¯"}
ç»å¸¸ä½¿ç”¨åœ¨é…ç½®æ–‡ä»¶ä¸­,==è®©é…ç½®æ–‡ä»¶ä¸­åŒ…å«å˜é‡==

copyæ¨¡å—å°±æ²¡æœ‰è§£æå˜é‡

templateæ¨¡å— ä¼ è¾“çš„æ—¶å€™è§£æé…ç½®æ–‡ä»¶ä¸­å˜é‡(ansible),é…ç½®æ–‡ä»¶æ ¼å¼æ”¹ä¸º exports.j2
:::


```
root@m01 /server/ans/playbook]$ cat 21-jinja-fenfa-conf.yml
--- 
- hosts: nfs
  tasks:
    - name: åˆ†å‘nfsé…ç½®æ–‡ä»¶,åŠ ä¸»æœºå
      template:
        src: ./exports.j2
        dest: /etc/exports
        
[root@m01 /server/ans/playbook]$ cat > exports.j2 <<'EOF'
 # {{ ansible_hostname }} nfsé…ç½®æ–‡ä»¶... 
 /data  172.16.1.0/24(rw,all_squash)
EOF
```

![20241129233608](https://liu-fu-gui.github.io/myimg/halo/20241129233608.png)
### ä½¿ç”¨jinja2æ¨¡æ¿è¦æ±‚: â­ â­ â­ â­ â­ ğŸ…° é…ç½®æ–‡ä»¶è¦ä»¥**.j2**ç»“å°¾(ansible) ğŸ…± åˆ†å‘æ–‡ä»¶çš„æ—¶å€™,ä½¿ç”¨templateæ¨¡å—,templateç”¨æ³•ä¸copyä¸€è‡´.



### jinja2å¾ªç¯(äº†è§£)

```
æ‰¹é‡å…±äº«ç›®å½•/data /backup /nfsdata 
[root@m01 /server/ans/playbook]$ cat > 21-jinja-fenfa-conf.yml <<'EOF'
--- 
- hosts: nfs
  tasks: 
    - name: åˆ†å‘nfsé…ç½®æ–‡ä»¶,åŠ ä¸»æœºå
      template:     
        src: ./exports.j2
        dest: /etc/exports
EOF

[root@m01 /server/ans/playbook]$ cat exports.j2 
 # {{ ansible_hostname }} nfsé…ç½®æ–‡ä»¶...
{% for name in [ "/data","/backup","/nfsdata" ] %}
{{ name }}  172.16.1.0/24(rw,all_squash)
{% endfor %}
```

:::tip{title="jinja2å°ç»“"}
æ ¸å¿ƒæŒæ¡:

é…ç½®æ–‡ä»¶xxxx.j2 + templateæ¨¡å—
jinja2é…ç½®æ–‡ä»¶æ”¯æŒanså˜é‡.
:::

## Roles

:::info{title="ç›¸å…³ä¿¡æ¯"}
roles: è§„èŒƒå‰§æœ¬ç›¸å…³çš„ç›®å½•.æœ¬è´¨è§„å®šçš„å‡ ä¸ªä¸“ç”¨çš„ç›®å½•
:::

### å‰§æœ¬nfsæœåŠ¡ç«¯

```
---
- hosts: nfs
  tasks:
    - name: 01. éƒ¨ç½²nfsæœåŠ¡ç«¯è½¯ä»¶
      yum:
        name: nfs-utils
        state: installed
    
    - name: 02. ä¿®æ”¹é…ç½®æ–‡ä»¶
      template:
        src: ./exports.j2
        dest: /etc/exports
        backup: yes 
      notify:
        - 04.å¯åŠ¨æœåŠ¡-rpcbind-nfsæœåŠ¡  
    - name: 03. åˆ›å»ºå¯¹åº”çš„ç›®å½•,æƒé™
      file:
        path: /data/
        owner: nfsnobody
        group: nfsnobody
        state: directory
    
  handlers:   
    - name: 04.å¯åŠ¨æœåŠ¡-rpcbind-nfsæœåŠ¡
      systemd:
        name: "{{ item }}"
        enabled: yes 
        state: restarted
      with_items:
        - rpcbind 
        - nfs
```
### å‰§æœ¬è½¬æ¢ä¸ºrolesæ ¼å¼

![20241129233651](https://liu-fu-gui.github.io/myimg/halo/20241129233651.png)
rolesç»“æ„
![20241129233659](https://liu-fu-gui.github.io/myimg/halo/20241129233659.png)

#### ç¯å¢ƒå‡†å¤‡åŠéƒ¨ç½²æµç¨‹
1. å…ˆä¹¦å†™æˆ–æ‹†åˆ†å‰§æœ¬ä¸­tasksçš„å†…å®¹.
2. æ ¹æ®å‰§æœ¬,åˆ†ç±»å­˜æ”¾é…ç½®æ–‡ä»¶,æ¨¡æ¿æ–‡ä»¶(j2)
3. æ ¹æ®å‰§æœ¬,é…ç½®handlersçš„main.ymlæ–‡ä»¶
4. ä¹¦å†™å…¥å£å‰§æœ¬. ä¸nfs-serverç›®å½•åŒçº§


```
mkdir roles
cd roles/
mkdir -p nfs-server/{files,templates,tasks,handlers}
```

1.å…ˆä¹¦å†™æˆ–æ‹†åˆ†å‰§æœ¬ä¸­tasksçš„å†…å®¹.

```
1. å…ˆä¹¦å†™æˆ–æ‹†åˆ†å‰§æœ¬ä¸­tasksçš„å†…å®¹.
[root@m01 /server/ans/playbook/roles]$ tree -F
.
â””â”€â”€ nfs-server/
  â”œâ”€â”€ files/
  â”œâ”€â”€ handlers/
  â”œâ”€â”€ tasks/
  â””â”€â”€ templates/

5 directories, 0 files
[root@m01 /server/ans/playbook/roles]$ vim nfs-server/tasks/main.yml


[root@m01 /server/ans/playbook/roles]$ tree -F 
.
â””â”€â”€ nfs-server/
  â”œâ”€â”€ files/
  â”œâ”€â”€ handlers/
  â”œâ”€â”€ tasks/
  â”‚ â””â”€â”€ main.yml
  â””â”€â”€ templates/

5 directories, 1 file
[root@m01 /server/ans/playbook/roles]# cat > nfs-server/tasks/main.yml <<'EOF'
- name: 01. éƒ¨ç½²nfsæœåŠ¡ç«¯è½¯ä»¶
  yum:
    name: nfs-utils
    state: installed

- name: 02. ä¿®æ”¹é…ç½®æ–‡ä»¶
  template:
    src: ./exports.j2
    dest: /etc/exports
    backup: yes
  notify:
      - 04.å¯åŠ¨æœåŠ¡-rpcbind-nfsæœåŠ¡
- name: 03. åˆ›å»ºå¯¹åº”çš„ç›®å½•,æƒé™
  file:
    path: /data/
    owner: nfsnobody
    group: nfsnobody
    state: directory
EOF
```

2.æ ¹æ®å‰§æœ¬,åˆ†ç±»å­˜æ”¾é…ç½®æ–‡ä»¶,æ¨¡æ¿æ–‡ä»¶(j2)

```
2. æ ¹æ®å‰§æœ¬,åˆ†ç±»å­˜æ”¾é…ç½®æ–‡ä»¶,æ¨¡æ¿æ–‡ä»¶(j2)
[root@m01 /server/ans/playbook/roles]# cp ../exports.j2  nfs-server/templates/
[root@m01 /server/ans/playbook/roles]# tree -F 
.
â””â”€â”€ nfs-server/
  â”œâ”€â”€ files/
  â”œâ”€â”€ handlers/
  â”œâ”€â”€ tasks/
  â”‚ â””â”€â”€ main.yml
  â””â”€â”€ templates/
    â””â”€â”€ exports.j2
5 directories, 2 files

[root@m01 /server/ans/playbook/roles]# cat > nfs-server/templates/exports.j2 <<'EOF'
# {{ ansible_hostname }} nfsé…ç½®æ–‡ä»¶
/data/  172.16.1.0/24(rw,all_squash)
EOF
```
3.æ ¹æ®å‰§æœ¬,é…ç½®handlersçš„main.ymlæ–‡ä»¶

```
3. æ ¹æ®å‰§æœ¬,é…ç½®handlersçš„main.ymlæ–‡ä»¶
[root@m01 /server/ans/playbook/roles]# tree -F 
.
â””â”€â”€ nfs-server/
  â”œâ”€â”€ files/
  â”œâ”€â”€ handlers/
  â”‚ â””â”€â”€ main.yml
  â”œâ”€â”€ tasks/
  â”‚ â””â”€â”€ main.yml
  â””â”€â”€ templates/
    â””â”€â”€ exports.j2
5 directories, 3 files

[root@m01 /server/ans/playbook/roles]# cat > nfs-server/handlers/main.yml <<'EOF'
- name: 04.å¯åŠ¨æœåŠ¡-rpcbind-nfsæœåŠ¡
  systemd:
    name: '{{ item }}'
    enabled: yes
    state: restarted
  with_items:
    - rpcbind
    - nfs
EOF
```
4.ä¹¦å†™å…¥å£å‰§æœ¬. ä¸nfs-serverç›®å½•åŒçº§

```
4. ä¹¦å†™å…¥å£å‰§æœ¬. ä¸nfs-serverç›®å½•åŒçº§.
  top.yml
[root@m01 /server/ans/playbook/roles]$ cat > top.yml <<'EOF'
---
- hosts: nfs
  roles:
    - role: nfs-server
EOF

[root@m01 /server/ans/playbook/roles]$ tree -F
.
â”œâ”€â”€ nfs-server/
â”‚ â”œâ”€â”€ files/
â”‚ â”œâ”€â”€ handlers/
â”‚ â”‚ â””â”€â”€ main.yml
â”‚ â”œâ”€â”€ tasks/
â”‚ â”‚ â””â”€â”€ main.yml
â”‚ â””â”€â”€ templates/
â”‚   â””â”€â”€ exports.j2
â””â”€â”€ top.yml            #æ³¨æ„top.ymlä¸nfs-serveråœ¨åŒä¸€å±‚ç›®å½•ã€‚
5 directories, 4 files


[root@m01 /server/ans/playbook]$ ansible-playbook -i hosts top.yml
```

####  rolesæ‰§è¡Œæµç¨‹
1. ansible-playbook -i hosts top.yml
2. è¯»å–top.ymlå†…å®¹ è·å– roles ä¿¡æ¯
3. æ ¹æ®é¡ºåºå…ˆæ‰§è¡Œç¬¬1ä¸ªrole---->nfs-server
4. æ‰§è¡Œnfs-server,æ‰¾nfs-serverå¯¹åº”çš„ç›®å½•
5. æ‰§è¡Œé‡Œé¢çš„tasksä¸‹é¢çš„main.yml
6. æ‰§è¡Œmain.ymlçš„æ—¶å€™ï¼Œé‡åˆ°copy/templateæ¨¡å—åˆ™æ‰¾å¯¹åº”çš„ç›®å½•copyï¼ˆfiles),template(templates)ï¼Œæ‰¾å¯¹åº”çš„æ–‡ä»¶ã€‚
7. æ‰§è¡Œmain.ymlçš„æ—¶å€™ï¼Œé‡åˆ°notify,åˆ™ä¼šæ‰¾handlersä¸‹é¢çš„main.ymlçš„å†…å®¹ï¼Œè¿›è¡ŒåŒ¹é…ä¸æ‰§è¡Œ

### Galaxy - äº†è§£
å®˜æ–¹rolesé›†åˆ.

```
ansible-galaxy install geerlingguy.nginx /root/.ansible/roles/
```
### Ansible-vault äº†è§£
åŠ å¯†æ–‡ä»¶

```
ansible-vault encrypt hosts      #åŠ å¯†è¿™ä¸ªæ–‡ä»¶,è®¾ç½®å¯†ç 
ansible --ask-vault-pass -i hosts all -m ping     #ä½¿ç”¨ansibleå‘½ä»¤æˆ–ansible-playbookå‘½ä»¤éœ€è¦åŠ ä¸Š--ask-vault-pass
```
# Ansible-è¿›é˜¶-ä¼˜åŒ–

```
/etc/ansible/ansible.cfg
inventory   = /etc/ansible/hosts #æŒ‡å®šçš„é»˜è®¤çš„ä¸»æœºæ¸…å•. æœªæ¥å¯ä»¥ä¿®æ”¹ä¸º ./hosts å°±å¯ä»¥ä¸ç”¨åŠ ä¸Š-i
forks     = 50         #å¹¶å‘æ•°é‡. å¯ä»¥å¢åŠ è¿™ä¸ªæ•°é‡è·å–æ›´å¿«æ‰¹é‡ç®¡ç†æ•ˆç‡.
sudo_user    = root    #é…ç½®ä¸‹è¢«ç®¡ç†ç«¯å…·æœ‰sudoæƒé™çš„ç”¨æˆ·,å¹¶ä¸”ä¿®æ”¹/etc/sudoers æ³¨é‡Šæ‰requiretty
host_key_checking = False  #é»˜è®¤æ˜¯True è¿æ¥æ–°çš„ä¸»æœºè¦è¿›è¡ŒéªŒè¯. å»ºè®®å…³é—­,åŠ é€Ÿ.
log_path = /var/log/ansible.log  #é»˜è®¤æ²¡æœ‰å¼€å¯.
ssh_args = -C -o ControlMaster=auto -o ControlPersist=6d   #è¿æ¥çš„ä¿æŒæ—¶é—´. 6d 10d
pipelining = True         #åŠ é€Ÿ,åŠ é€Ÿè¿æ¥åˆå¹¶ä¸å¿…è¦çš„è¿æ¥. è¦æ±‚:ä¸èƒ½ä½¿ç”¨sudo,å¦‚æœä½¿ç”¨åˆ™ä¸èƒ½å¼€å¯.
```